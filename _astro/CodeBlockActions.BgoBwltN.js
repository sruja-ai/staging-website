import{r as Y,R as S}from"./index.BkaWJOLo.js";import{c as $}from"./client.zxf4N4IQ.js";import"./jsx-runtime.D_zvdyIk.js";import"./PosthogProvider.DsEhGCey.js";import{S as X,c as J,i as G}from"./wasmAdapter.CPIXKx3K.js";import{c as q}from"./auto.qXY55obW.js";/* empty css                       */import{S as N}from"./SrujaLoader.CMDi8PfZ.js";import{m as R}from"./mermaid.core.C5uN7fyi.js";import{l as V}from"./lz-string.B_aGPXAY.js";import{g as K}from"./designer-url.lSLuUBgX.js";import"./index.Bf_o2Pin.js";import"./env.DcWn_g7b.js";let D=!1;function F(){try{return(document.documentElement.getAttribute("data-theme")||"")==="dark"?"dark":"default"}catch{return"default"}}function B(){try{if(R.initialize({startOnLoad:!1,theme:F(),securityLevel:"loose",flowchart:{useMaxWidth:!0,htmlLabels:!0,subGraphTitleMargin:{top:10,bottom:20}}}),!D){try{window.addEventListener("theme-change",()=>{try{R.initialize({theme:F()})}catch{}})}catch{}D=!0}}catch{}}async function O(o,L){o.innerHTML="";const b=document.createElement("div");b.style.display="flex",b.style.alignItems="center",b.style.justifyContent="center",b.style.padding="16px";const i=$.createRoot(b);o.appendChild(b),i.render(S.createElement("div",{style:{textAlign:"center",color:"var(--color-text-secondary)"}},S.createElement(N,{size:32}),S.createElement("div",{style:{marginTop:8,fontSize:12}},"Rendering diagram...")));try{const p=(n=>n.replace(/\u2192/g,"->").replace(/[“”]/g,'"').replace(/[’]/g,"'").replace(/\u2013|\u2014/g,"-").split(/\r?\n/).map(k=>k.replace(/^\s*\d+\s*[→:.-]\s?/,"")).join(`
`))(L);let c=null;try{c=await J(p)}catch(n){const m=n instanceof Error?n.message:String(n);throw console.error("[CodeBlockActions] convertDslToMermaid error:",n),new Error(`Failed to generate mermaid diagram: ${m}`)}if(!c||c.trim().length===0)try{const n=await G();if(!n)throw new Error("WASM not initialized. Please refresh the page.");const m=await n.parseDslToJson(p);if(!m||m.trim().length===0)throw new Error("Failed to parse DSL. Please check your syntax.");try{if(!((JSON.parse(m)?.model?.items||[]).length>0))throw new Error("Mermaid export failed: No elements found in model. Please ensure your DSL defines systems, containers, or other elements.")}catch{}throw new Error("Mermaid export failed. The exporter returned an empty result. Please check browser console for details.")}catch(n){const m=n instanceof Error?n.message:String(n);throw new Error(`Failed to generate mermaid diagram: ${m}`)}const v=((c||"").split(`
`)[0]||"").match(/^%%\s*node_count:\s*(\d+)\s*%%$/);let a=v?parseInt(v[1],10):void 0;if(typeof a!="number"||Number.isNaN(a)){const n=p.split(/\r?\n/),m=/^\s*(architecture|system|container|component|person|deployment|datastore|queue|external)\b/i;a=n.filter(k=>m.test(k)).length}const y=a<=10?{w:600,h:400}:a<=20?{w:800,h:600}:a<=35?{w:1e3,h:700}:a<=60?{w:1200,h:800}:{w:1400,h:900},w="sruja-"+Math.random().toString(36).slice(2);i.unmount(),o.innerHTML="";const g=document.createElement("div");g.style.transformOrigin="top left",g.style.display="inline-block",g.style.willChange="transform";const C=await R.render(w,c);g.innerHTML=C?.svg||"";const M=g.querySelector("svg");M&&(M.style.overflow="visible"),o.appendChild(g);const t=o;t.style.minHeight="";const u=g.querySelector("svg");u&&(u.style.width=`${y.w}px`,u.style.maxWidth="none",u.style.height="auto",u.setAttribute("preserveAspectRatio","xMidYMid meet")),g.style.transform="translate(0px, 0px) scale(1)",o.dataset.scale="1",o.dataset.tx="0",o.dataset.ty="0",o.dataset.inner="1"}catch(l){i.unmount();const p=l instanceof Error?l.message:String(l),c=document.querySelector("h1")?.textContent||document.title||"Unknown Page",f=(()=>{const y=o.closest("pre")?.parentElement;if(!y)return null;let w=y.previousElementSibling;for(;w;){if(w.tagName?.match(/^H[1-6]$/))return w.textContent||null;w=w.previousElementSibling}const g=y.closest('article, section, main, [class*="content"]');if(g){const C=g.querySelectorAll("h2, h3, h4, h5, h6");if(C.length>0)return C[C.length-1].textContent||null}return null})(),a=`Failed to render diagram in "${f?`${c} > ${f}`:c}": ${p}`;o.innerHTML=`<div style="padding:8px;color:var(--color-error-500)">${a}</div>`;try{q("diagram.render_error",{error_message:p,page_title:c,section_title:f||"",page_path:window.location.pathname,error_type:l instanceof Error?l.constructor.name:typeof l,dsl_preview:L.substring(0,200)})}catch(y){console.warn("Failed to track error to PostHog:",y)}}}function Q(o,L,b){const i=document.createElement("div");i.style.display="flex",i.style.gap="8px",i.style.position="absolute",i.style.right="12px",i.style.top="12px",i.style.zIndex="10";const l={padding:"6px 10px",borderRadius:"6px",border:"1px solid var(--color-border)",background:"var(--color-background)",color:"var(--color-text-primary)",cursor:"pointer",fontSize:"12px"},p=document.createElement("button");p.textContent="Show Diagram",Object.assign(p.style,l);const c=document.createElement("button");c.textContent="Open in Designer",Object.assign(c.style,l);let f=b;c.onclick=()=>{const r=f||"",e=K();try{const s=encodeURIComponent(V.compressToBase64(r));window.open(`${e}?code=${s}`,"_blank")}catch{window.open(`${e}?code=${encodeURIComponent(r)}`,"_blank")}try{window.dispatchEvent(new CustomEvent("sruja:event",{detail:{type:"tutorial.open_designer"}}))}catch{}},i.appendChild(p),i.appendChild(c);const v=document.createElement("div");v.style.position="relative",o.parentElement?.insertBefore(v,o);const a=document.createElement("div");a.style.width="100%",a.style.maxHeight="640px",a.style.height="auto",a.style.minHeight="200px",v.appendChild(a);const y=$.createRoot(a),w=()=>document.documentElement.getAttribute("data-theme")==="dark"?"vs-dark":"vs";let g=w();const C=r=>{const e=r.split(`
`).length;return`${Math.min(Math.max(e*20+40,200),640)}px`},M=()=>{const r=C(f);a.style.height=r,y.render(S.createElement(X,{value:f,onChange:e=>{f=e||"";const s=C(f);a.style.height=s},theme:g,options:{minimap:{enabled:!1},wordWrap:"on",fontSize:14,automaticLayout:!0,scrollBeyondLastLine:!1},height:r}))};M();try{window.addEventListener("theme-change",()=>{g=w(),M()})}catch{}o.style.display="none",v.appendChild(o),v.appendChild(i);const t=document.createElement("div");t.style.border="1px solid var(--color-border)",t.style.borderRadius="6px",t.style.marginTop="12px",t.style.overflow="auto",t.style.background="var(--color-background)",t.style.maxHeight="720px",t.style.position="relative",t.style.display="none",v.appendChild(t);const u=document.createElement("div");u.style.position="absolute",u.style.bottom="8px",u.style.right="8px",u.style.display="flex",u.style.gap="6px",u.style.zIndex="5";const n=document.createElement("button");Object.assign(n.style,l),n.style.padding="8px",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.innerHTML=`
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
    </svg>
  `,n.setAttribute("aria-label","Expand diagram"),u.appendChild(n),u.style.display="none",t.appendChild(u);const m=document.createElement("div");m.style.width="100%",m.style.height="100%",m.style.position="relative",t.appendChild(m);const k=()=>{t.dataset.rendered!=="1"&&(t.dataset.rendered="1",B(),O(m,f),u.style.display="flex")};p.onclick=()=>{if(t.style.display!=="none")t.style.display="none",p.textContent="Show Diagram";else{try{window.dispatchEvent(new CustomEvent("sruja:event",{detail:{type:"tutorial.diagram_show"}}))}catch{}k(),t.style.display="block",p.textContent="Hide Diagram"}};const z=async r=>{try{window.dispatchEvent(new CustomEvent("sruja:event",{detail:{type:"tutorial.diagram_expand"}}))}catch{}const e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.right="0",e.style.bottom="0",e.style.background="var(--overlay-scrim)",e.style.zIndex="10000",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center";const s=document.createElement("div");s.style.background="var(--color-background)",s.style.width="90vw",s.style.height="85vh",s.style.borderRadius="8px",s.style.boxShadow="0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04)",s.style.position="relative";const x=document.createElement("button");x.textContent="Close",Object.assign(x.style,l),x.style.position="absolute",x.style.top="12px",x.style.right="12px";const d=document.createElement("div");d.style.width="100%",d.style.height="100%",d.style.borderTopLeftRadius="8px",d.style.borderTopRightRadius="8px",d.style.overflow="hidden",s.appendChild(x),s.appendChild(d),e.appendChild(s),document.body.appendChild(e),x.onclick=()=>{document.body.removeChild(e)};const E=document.createElement("div");E.style.display="flex",E.style.alignItems="center",E.style.justifyContent="center",E.style.height="100%";const _=$.createRoot(E);d.appendChild(E),_.render(S.createElement("div",{style:{textAlign:"center",color:"var(--color-text-tertiary)"}},S.createElement(N,{size:32}),S.createElement("div",{style:{marginTop:8,fontSize:12}},"Loading diagram...")));try{_.unmount(),d.innerHTML="",d.style.padding="20px",d.style.overflow="auto",d.style.display="flex",d.style.alignItems="center",d.style.justifyContent="center";const h=document.createElement("div");h.style.width="100%",h.style.height="100%",h.style.display="flex",h.style.alignItems="center",h.style.justifyContent="center",d.appendChild(h),B(),await O(h,r)}catch(h){_.unmount();const I=h instanceof Error?h.message:String(h),A=document.querySelector("h1")?.textContent||document.title||"Unknown Page",U=`Failed to open designer in "${A}": ${I}`;d.innerHTML=`<div style="padding:16px;color:var(--color-error-500)">${U}</div>`;try{q("designer.open_error",{error_message:I,page_title:A,page_path:window.location.pathname,error_type:h instanceof Error?h.constructor.name:typeof h})}catch(W){console.warn("Failed to track error to PostHog:",W)}}};n.onclick=async()=>{await z(f)};let j=!1,T=0,H=0;t.addEventListener("mousedown",r=>{parseFloat(t.dataset.scale||"1")<=1||(j=!0,T=r.clientX,H=r.clientY,r.preventDefault())}),window.addEventListener("mouseup",()=>{j=!1}),window.addEventListener("mousemove",r=>{if(!j)return;const e=parseFloat(t.dataset.scale||"1"),s=parseFloat(t.dataset.tx||"0"),x=parseFloat(t.dataset.ty||"0"),d=r.clientX-T,E=r.clientY-H;T=r.clientX,H=r.clientY,P(e,s+d,x+E)});const P=(r,e,s)=>{const x=m.firstElementChild;x&&(x.style.transform=`translate(${e}px, ${s}px) scale(${r})`,t.dataset.scale=String(r),t.dataset.tx=String(e),t.dataset.ty=String(s))}}function pe(){return Y.useEffect(()=>{const o=()=>{Array.from(document.querySelectorAll("pre code, pre.astro-code code")).forEach(i=>{const l=i.parentElement;if(!l||l.dataset.srujaToolbar==="1")return;const p=i.className||"",c=p.match(/language-(\w+)|lang-(\w+)/i),f=c?(c[1]||c[2]).toLowerCase():null,v=i.getAttribute("data-language")||l.getAttribute("data-language")||"",a=f==="sruja"||v.toLowerCase()==="sruja"||/language-sruja|lang-sruja/i.test(p)||/language-sruja|lang-sruja/i.test(l.className||""),y=i.textContent||"",w=!a&&/\b(architecture|system|container|component|person|deployment|datastore|queue|external|scenario|story|flow)\b/i.test(y)&&(/\b(->|<-|=>|<=)\b/.test(y)||/\b(description|technology|owner)\s*"/i.test(y));(a||w)&&y.trim()&&(Q(l,i,y),l.dataset.srujaToolbar="1")})};o();const L=new MutationObserver(()=>o());return L.observe(document.body,{childList:!0,subtree:!0}),()=>L.disconnect()},[]),null}export{pe as default};
