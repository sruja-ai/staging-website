import{r as K,R as k}from"./index.DM7nOceM.js";import{c as A}from"./client.BCzR3rLS.js";import"./jsx-runtime.D_zvdyIk.js";import"./PosthogProvider.DT9wrO5O.js";import{h as Q,f as V,a as ee}from"./wasmAdapter.D7m4C-8Z.js";import{c as U}from"./posthog.D98OsGe_.js";/* empty css                       */import{S as X}from"./SrujaLoader.lh90-mjg.js";import{m as F}from"./mermaid.core.D6gEPAzQ.js";import{l as te}from"./lz-string.zy5d-oe8.js";import"./index.DtZLTQNg.js";import"./preload-helper.BlTxHScW.js";let P=!1;function N(){try{return(document.documentElement.getAttribute("data-theme")||"")==="dark"?"dark":"default"}catch{return"default"}}function W(){try{if(F.initialize({startOnLoad:!1,theme:N(),securityLevel:"loose",flowchart:{useMaxWidth:!0,htmlLabels:!0,subGraphTitleMargin:{top:10,bottom:20}}}),!P){try{window.addEventListener("theme-change",()=>{try{F.initialize({theme:N()})}catch{}})}catch{}P=!0}}catch{}}async function Y(o,S){o.innerHTML="";const w=document.createElement("div");w.style.display="flex",w.style.alignItems="center",w.style.justifyContent="center",w.style.padding="16px";const i=A.createRoot(w);o.appendChild(w),i.render(k.createElement("div",{style:{textAlign:"center",color:"var(--color-text-secondary)"}},k.createElement(X,{size:32}),k.createElement("div",{style:{marginTop:8,fontSize:12}},"Rendering diagram...")));try{const m=(a=>a.replace(/\u2192/g,"->").replace(/[“”]/g,'"').replace(/[’]/g,"'").replace(/\u2013|\u2014/g,"-").split(/\r?\n/).map(L=>L.replace(/^\s*\d+\s*[→:.-]\s?/,"")).join(`
`))(S);let p=null;try{p=await V(m)}catch(a){const f=a instanceof Error?a.message:String(a);throw console.error("[CodeBlockActions] convertDslToMermaid error:",a),new Error(`Failed to generate mermaid diagram: ${f}`)}if(!p)try{const a=await ee();if(!a)throw new Error("WASM not initialized. Please refresh the page.");const f=await a.parseDslToJson(m);throw!f||f.trim().length===0?new Error("Failed to parse DSL. Please check your syntax."):(console.error("[CodeBlockActions] Parsing succeeded but mermaid export returned null. JSON:",f.substring(0,200)),new Error("Mermaid export failed. The TypeScript exporter returned null. Please check browser console for details."))}catch(a){const f=a instanceof Error?a.message:String(a);throw new Error(`Failed to generate mermaid diagram: ${f}`)}const b=((p||"").split(`
`)[0]||"").match(/^%%\s*node_count:\s*(\d+)\s*%%$/);let r=b?parseInt(b[1],10):void 0;if(typeof r!="number"||Number.isNaN(r)){const a=m.split(/\r?\n/),f=/^\s*(architecture|system|container|component|person|deployment|datastore|queue|external)\b/i;r=a.filter(L=>f.test(L)).length}const u=r<=10?{w:600,h:400}:r<=20?{w:800,h:600}:r<=35?{w:1e3,h:700}:r<=60?{w:1200,h:800}:{w:1400,h:900},v="sruja-"+Math.random().toString(36).slice(2);i.unmount(),o.innerHTML="";const y=document.createElement("div");y.style.transformOrigin="top left",y.style.display="inline-block",y.style.willChange="transform";const C=await F.render(v,p);y.innerHTML=C?.svg||"";const j=y.querySelector("svg");j&&(j.style.overflow="visible"),o.appendChild(y);const t=o;t.style.minHeight=`${u.h}px`;const c=y.querySelector("svg");c&&(c.style.width=`${u.w}px`,c.style.maxWidth="none",c.style.height="auto",c.setAttribute("preserveAspectRatio","xMidYMid meet")),y.style.transform="translate(0px, 0px) scale(1)",o.dataset.scale="1",o.dataset.tx="0",o.dataset.ty="0",o.dataset.inner="1"}catch(l){i.unmount();const m=l instanceof Error?l.message:String(l),p=document.querySelector("h1")?.textContent||document.title||"Unknown Page",x=(()=>{const u=o.closest("pre")?.parentElement;if(!u)return null;let v=u.previousElementSibling;for(;v;){if(v.tagName?.match(/^H[1-6]$/))return v.textContent||null;v=v.previousElementSibling}const y=u.closest('article, section, main, [class*="content"]');if(y){const C=y.querySelectorAll("h2, h3, h4, h5, h6");if(C.length>0)return C[C.length-1].textContent||null}return null})(),r=`Failed to render diagram in "${x?`${p} > ${x}`:p}": ${m}`;o.innerHTML=`<div style="padding:8px;color:var(--color-error-500)">${r}</div>`;try{U("diagram.render_error",{error_message:m,page_title:p,section_title:x||"",page_path:window.location.pathname,error_type:l instanceof Error?l.constructor.name:typeof l,dsl_preview:S.substring(0,200)})}catch(u){console.warn("Failed to track error to PostHog:",u)}}}function ne(o,S,w){const i=document.createElement("div");i.style.display="flex",i.style.gap="8px",i.style.position="absolute",i.style.right="12px",i.style.top="12px",i.style.zIndex="10";const l={padding:"6px 10px",borderRadius:"6px",border:"1px solid var(--color-border)",background:"var(--color-background)",color:"var(--color-text-primary)",cursor:"pointer",fontSize:"12px"},m=document.createElement("button");m.textContent="Show Diagram",Object.assign(m.style,l);const p=document.createElement("button");p.textContent="Open in Designer",Object.assign(p.style,l);let x=w;p.onclick=()=>{const n=x||"";try{const e=encodeURIComponent(te.compressToBase64(n));window.open(`/designer#code=${e}`,"_blank")}catch{window.open(`/designer?code=${encodeURIComponent(n)}`,"_blank")}try{window.dispatchEvent(new CustomEvent("sruja:event",{detail:{type:"tutorial.open_designer"}}))}catch{}},i.appendChild(m),i.appendChild(p);const b=document.createElement("div");b.style.position="relative",o.parentElement?.insertBefore(b,o);const r=document.createElement("div");r.style.width="100%",r.style.maxHeight="640px",r.style.height="auto",r.style.minHeight="200px",b.appendChild(r);const u=A.createRoot(r),v=()=>document.documentElement.getAttribute("data-theme")==="dark"?"vs-dark":"vs";let y=v();const C=n=>{const e=n.split(`
`).length;return`${Math.min(Math.max(e*20+40,200),640)}px`},j=()=>{const n=C(x);r.style.height=n,u.render(k.createElement(Q,{value:x,onChange:e=>{x=e||"";const d=C(x);r.style.height=d},theme:y,options:{minimap:{enabled:!1},wordWrap:"on",fontSize:14,automaticLayout:!0,scrollBeyondLastLine:!1},height:n}))};j();try{window.addEventListener("theme-change",()=>{y=v(),j()})}catch{}o.style.display="none",b.appendChild(o),b.appendChild(i);const t=document.createElement("div");t.style.border="1px solid var(--color-border)",t.style.borderRadius="6px",t.style.marginTop="12px",t.style.overflow="auto",t.style.background="var(--color-background)",t.style.maxHeight="720px",t.style.position="relative",t.style.display="none",b.appendChild(t);const c=document.createElement("div");c.style.position="absolute",c.style.bottom="8px",c.style.right="8px",c.style.display="flex",c.style.gap="6px",c.style.zIndex="5";const a=n=>{const e=document.createElement("button");return Object.assign(e.style,l),e.textContent=n,e},f=a("+"),L=a("-"),I=a("Reset"),B=a("Expand");c.appendChild(f),c.appendChild(L),c.appendChild(I),c.appendChild(B),c.style.display="none",t.appendChild(c);const M=document.createElement("div");M.style.width="100%",M.style.height="100%",M.style.position="relative",t.appendChild(M);const T=()=>{t.dataset.rendered!=="1"&&(t.dataset.rendered="1",W(),Y(M,x),c.style.display="flex")};m.onclick=()=>{if(t.style.display!=="none")t.style.display="none",m.textContent="Show Diagram";else{try{window.dispatchEvent(new CustomEvent("sruja:event",{detail:{type:"tutorial.diagram_show"}}))}catch{}T(),t.style.display="block",m.textContent="Hide Diagram"}};const H=n=>{const e=parseFloat(t.dataset.scale||"1"),d=n===null?1:Math.max(.25,Math.min(4,e+n)),g=parseFloat(t.dataset.tx||"0"),s=parseFloat(t.dataset.ty||"0");O(d,g,s)};f.onclick=()=>{T(),H(.25)},L.onclick=()=>{T(),H(-.25)},I.onclick=()=>{T(),H(null)};const J=async n=>{try{window.dispatchEvent(new CustomEvent("sruja:event",{detail:{type:"tutorial.diagram_expand"}}))}catch{}const e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.right="0",e.style.bottom="0",e.style.background="var(--overlay-scrim)",e.style.zIndex="10000",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center";const d=document.createElement("div");d.style.background="var(--color-background)",d.style.width="90vw",d.style.height="85vh",d.style.borderRadius="8px",d.style.boxShadow="0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04)",d.style.position="relative";const g=document.createElement("button");g.textContent="Close",Object.assign(g.style,l),g.style.position="absolute",g.style.top="12px",g.style.right="12px";const s=document.createElement("div");s.style.width="100%",s.style.height="100%",s.style.borderTopLeftRadius="8px",s.style.borderTopRightRadius="8px",s.style.overflow="hidden",d.appendChild(g),d.appendChild(s),e.appendChild(d),document.body.appendChild(e),g.onclick=()=>{document.body.removeChild(e)};const E=document.createElement("div");E.style.display="flex",E.style.alignItems="center",E.style.justifyContent="center",E.style.height="100%";const z=A.createRoot(E);s.appendChild(E),z.render(k.createElement("div",{style:{textAlign:"center",color:"var(--color-text-tertiary)"}},k.createElement(X,{size:32}),k.createElement("div",{style:{marginTop:8,fontSize:12}},"Loading diagram...")));try{z.unmount(),s.innerHTML="",s.style.padding="20px",s.style.overflow="auto",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center";const h=document.createElement("div");h.style.width="100%",h.style.height="100%",h.style.display="flex",h.style.alignItems="center",h.style.justifyContent="center",s.appendChild(h),W(),await Y(h,n)}catch(h){z.unmount();const D=h instanceof Error?h.message:String(h),q=document.querySelector("h1")?.textContent||document.title||"Unknown Page",Z=`Failed to open designer in "${q}": ${D}`;s.innerHTML=`<div style="padding:16px;color:var(--color-error-500)">${Z}</div>`;try{U("designer.open_error",{error_message:D,page_title:q,page_path:window.location.pathname,error_type:h instanceof Error?h.constructor.name:typeof h})}catch(G){console.warn("Failed to track error to PostHog:",G)}}};B.onclick=async()=>{await J(x)};let _=!1,R=0,$=0;t.addEventListener("mousedown",n=>{parseFloat(t.dataset.scale||"1")<=1||(_=!0,R=n.clientX,$=n.clientY,n.preventDefault())}),window.addEventListener("mouseup",()=>{_=!1}),window.addEventListener("mousemove",n=>{if(!_)return;const e=parseFloat(t.dataset.scale||"1"),d=parseFloat(t.dataset.tx||"0"),g=parseFloat(t.dataset.ty||"0"),s=n.clientX-R,E=n.clientY-$;R=n.clientX,$=n.clientY,O(e,d+s,g+E)});const O=(n,e,d)=>{const g=M.firstElementChild;g&&(g.style.transform=`translate(${e}px, ${d}px) scale(${n})`,t.dataset.scale=String(n),t.dataset.tx=String(e),t.dataset.ty=String(d))}}function ge(){return K.useEffect(()=>{const o=()=>{Array.from(document.querySelectorAll("pre code, pre.astro-code code")).forEach(i=>{const l=i.parentElement;if(!l||l.dataset.srujaToolbar==="1")return;const m=i.className||"",p=m.match(/language-(\w+)|lang-(\w+)/i),x=p?(p[1]||p[2]).toLowerCase():null,b=i.getAttribute("data-language")||l.getAttribute("data-language")||"",r=x==="sruja"||b.toLowerCase()==="sruja"||/language-sruja|lang-sruja/i.test(m)||/language-sruja|lang-sruja/i.test(l.className||""),u=i.textContent||"",v=!r&&/\b(architecture|system|container|component|person|deployment|datastore|queue|external|scenario|story|flow)\b/i.test(u)&&(/\b(->|<-|=>|<=)\b/.test(u)||/\b(description|technology|owner)\s*"/i.test(u));(r||v)&&u.trim()&&(ne(l,i,u),l.dataset.srujaToolbar="1")})};o();const S=new MutationObserver(()=>o());return S.observe(document.body,{childList:!0,subtree:!0}),()=>S.disconnect()},[]),null}export{ge as default};
