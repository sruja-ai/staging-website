import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{r as k}from"./index.BkaWJOLo.js";import{B as L}from"./PosthogProvider.DsEhGCey.js";import{M as T}from"./MantineProvider.CZLGba5W.js";import{S as W,i as D}from"./wasmAdapter.BuhgPVib.js";/* empty css                       */import{a as O}from"./storage.3RYs70yn.js";import{t as M}from"./analytics.DAU6mwnx.js";import"./index.Bf_o2Pin.js";import"./auto.qXY55obW.js";import"./modelToDsl.0jPI0wak.js";function B(s,S){const i=[],p=s||"Parse error";i.push(p);const h=S.split(`
`);let n=null,m=null;const E=p.match(/line\s+(\d+)/i),y=p.match(/:(\d+):(\d+)/);if(E&&E[1]&&(n=parseInt(E[1],10)),y&&y[1]&&y[2]&&(n=parseInt(y[1],10),m=parseInt(y[2],10)),n&&n>=1&&n<=h.length){const j=Math.max(1,n-1),v=Math.min(h.length,n+1);for(let f=j;f<=v;f++){const H=f===n?">":" ",a=h[f-1];i.push(H+" Line "+f+": "+a)}if(m&&m>0&&n>=1&&n<=h.length){const f=" ".repeat(Math.max(0,("> Line "+n+": ").length+m-1))+"^";i.push(f)}}const d=p.toLowerCase();return(d.includes("unterminated string")||d.includes("missing quote")||d.includes("expected string"))&&i.push("Hint: Wrap labels and descriptions in quotes"),(d.includes("unexpected eof")||d.includes("missing closing brace")||d.includes("expected }"))&&i.push("Hint: Add a closing } for the last opened block"),(d.includes("unknown identifier")||d.includes("undefined reference"))&&i.push("Hint: Verify names are declared before use"),i.some(j=>j.startsWith("Hint:"))||h.some(v=>/->\s+[^\s]+\s+[^"\n]+$/.test(v))&&i.push('Hint: Relation labels should be quoted, e.g., Web -> API "Calls"'),i}const F={COMPLETED_CHALLENGES:"sruja:completedChallenges"},$=O(F.COMPLETED_CHALLENGES,[]);function I(){return $.get()}function q(s){const S=I(),i=new Set(S);i.add(s),$.set(Array.from(i))}function tt({challenge:s}){const[S,i]=k.useState(s.initialDsl),[p,h]=k.useState(!1),[n,m]=k.useState(null),[E,y]=k.useState(0),[d,j]=k.useState(0);k.useEffect(()=>{M("challenge.view",{slug:s.slug})},[s.slug]);const v=async()=>{h(!0),m(null);const a=[];try{y(l=>l+1);const C=await(await D()).parseDslToJson(S),b=JSON.parse(C);let w=!0;for(const l of s.checks)if(l.type==="noErrors")a.push(l.message||"No parse errors");else if(l.type==="relationExists"){const N=(t=>{const u=[],r=c=>{for(const o of c||[])o&&(o.from||o.source)&&(o.to||o.target)&&u.push({from:o.from??o.source,to:o.to??o.target})};r(t?.relations||[]);for(const c of t?.systems||[]){r(c?.relations||[]);for(const o of c?.containers||[]){r(o?.relations||[]);for(const A of o?.components||[])r(A?.relations||[])}for(const o of c?.components||[])r(o?.relations||[])}for(const c of t?.containers||[]){r(c?.relations||[]);for(const o of c?.components||[])r(o?.relations||[])}for(const c of t?.components||[])r(c?.relations||[]);return u})(b?.architecture||b),x=(t,u)=>{if(!u)return!1;const r=String(t||"").trim(),c=String(u||"").trim();if(!r||!c)return!1;if(r===c)return!0;const o=r.split(".").pop(),A=c.split(".").pop();return!!(o&&A&&o===A||r.endsWith("."+c))};N.some(t=>x(t.from,l.source)&&x(t.to,l.target))?a.push(`Found relation ${l.source} -> ${l.target}`):(w=!1,a.push(l.message||`Add relation ${l.source} -> ${l.target}`))}else if(l.type==="elementExists"){const R=new Set,N=t=>{if(t){if(Array.isArray(t)){for(const u of t)N(u);return}if(typeof t=="object"){const u=(t.name||t.id||"").toString().trim();u&&R.add(u);for(const r of Object.keys(t))N(t[r])}}};N(b?.architecture||b);const x=(l.name||"").toString().trim();x&&Array.from(R).some(t=>{if(!t)return!1;if(t===x)return!0;const u=t.split(".").pop(),r=x.split(".").pop();return!!u&&!!r&&u===r})?a.push(`Found element ${x}`):(w=!1,a.push(l.message||`Create element ${x}`))}if(m({passed:w,details:a}),w)try{q(s.slug)}catch{}M("challenge.run",{slug:s.slug,passed:w})}catch(g){const C=g instanceof Error?g.message:String(g),b=B(C,S);m({passed:!1,details:b})}finally{h(!1)}},f=()=>{if(!s.hints||s.hints.length===0)return;const a=Math.min(s.hints.length,d+1);j(a);const g=s.hints.slice(0,a);m(C=>({passed:!1,details:[...C?.details||[],...g]}))},H=()=>{s.solution&&i(s.solution)};return e.jsx(T,{children:e.jsxs("div",{className:"challenge",children:[e.jsxs("div",{className:"header",children:[e.jsx("h2",{children:s.title}),s.summary&&e.jsx("p",{className:"summary",children:s.summary})]}),e.jsx("div",{className:"editor",children:e.jsx(W,{value:S,onChange:a=>i(a||""),theme:"vs-dark",options:{minimap:{enabled:!1},fontSize:14,wordWrap:"on"}})}),e.jsxs("div",{className:"actions",children:[e.jsx(L,{variant:"primary",onClick:v,disabled:p,isLoading:p,children:p?"Running...":"Run Tests"}),E>=1&&!n?.passed&&e.jsxs(e.Fragment,{children:[e.jsx(L,{variant:"outline",onClick:f,disabled:p||(s.hints?.length||0)===d,children:"Show Hint"}),e.jsx(L,{variant:"outline",onClick:H,disabled:p||!s.solution,children:"Reveal Solution"})]})]}),n&&e.jsxs("div",{className:`result ${n.passed?"ok":"err"}`,children:[e.jsx("strong",{children:n.passed?"Challenge passed":"Needs fixes"}),e.jsx("ul",{children:n.details.map((a,g)=>e.jsx("li",{children:a},g))})]}),e.jsx("div",{className:"hint",children:e.jsx("small",{children:"Progress is saved locally in your browser."})}),e.jsx("style",{children:`
        .challenge { border: 1px solid var(--color-border); border-radius: 8px; padding: 16px; background: var(--color-background); }
        .summary { color: var(--color-text-tertiary); }
        .editor { height: 360px; margin-top: 12px; }
        .actions { margin-top: 12px; display: flex; gap: 8px; }
        .result { margin-top: 12px; padding: 12px; border-radius: 6px; }
        .result.ok { background: var(--success-dim); border: 1px solid var(--color-success-500); }
        .result.err { background: var(--error-dim); border: 1px solid var(--color-error-500); }
        .hint { margin-top: 8px; color: var(--color-text-tertiary); }
      `})]})})}export{tt as default};
