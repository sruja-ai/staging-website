const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["_astro/editor.main.zKduJmTH.js","_astro/index.DM7nOceM.js","_astro/index.C-nSUQJB.js","_astro/preload-helper.BlTxHScW.js","_astro/index.BgIV59R8.css"])))=>i.map(i=>d[i]);
import{_ as P}from"./preload-helper.BlTxHScW.js";import{j as B}from"./jsx-runtime.D_zvdyIk.js";import{r as E,p as J}from"./index.DM7nOceM.js";import{c as z}from"./posthog.Dnn64KkL.js";function K(e){e.languages.register({id:"sruja"}),e.languages.setMonarchTokensProvider("sruja",{tokenizer:{root:[[/\/\/.*$/,"comment"],[/\/\*[\s\S]*?\*\//,"comment"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/"/,{token:"string.quote",bracket:"@open",next:"@string"}],[/\d+\.\d+/,"number.float"],[/\d+/,"number"],[/\b(workspace|model|views|system|component|container|import|relation|requirements|adrs|functional|nonfunctional|constraint|true|false)\b/,"keyword"],[/->/,"operator"],[/[:=]/,"operator"],[/[{}]/,"delimiter.bracket"],[/[[\]]/,"delimiter.array"],[/[(),]/,"delimiter"],[/[a-zA-Z_][a-zA-Z0-9_]*/,"identifier"],[/\s+/,"white"]],string:[[/[^\\"]+/,"string"],[/\\./,"string.escape.invalid"],[/"/,{token:"string.quote",bracket:"@close",next:"@pop"}]]}}),e.languages.setLanguageConfiguration("sruja",{comments:{lineComment:"//",blockComment:["/*","*/"]},brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'}],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'}],indentationRules:{increaseIndentPattern:/^.*\{[^}]*$/,decreaseIndentPattern:/^\s*\}/}})}function q({value:e,onChange:r,language:t="plaintext",theme:i="vs",height:c="100%",options:d={},className:_,onReady:g}){const a=E.useRef(null),w=E.useRef(null),p=E.useRef(null);return E.useEffect(()=>{if(typeof window>"u"||w.current)return;let m=!0,u=null,j=null,b=null;typeof window.MonacoEnvironment>"u"&&(window.MonacoEnvironment={getWorker:function(h,y){const v=new Blob(["self.onmessage = () => {}"],{type:"application/javascript"});return new Worker(URL.createObjectURL(v))}});const k=()=>{if(!m)return;const h=a.current;if(!h){b=setTimeout(k,50);return}try{if(!h.parentNode||!h.isConnected||!document.body.contains(h)){b=setTimeout(k,50);return}}catch{b=setTimeout(k,50);return}P(()=>import("./editor.main.zKduJmTH.js").then(y=>y.e),__vite__mapDeps([0,1,2,3,4])).then(y=>{if(!m)return;const v=a.current;try{if(!v||!v.parentNode||!v.isConnected||!document.body.contains(v))return}catch{return}p.current=y;try{t==="sruja"&&K(y)}catch(S){console.warn("Failed to register language:",S);return}if(a.current){try{if(!a.current.parentNode||!a.current.isConnected||!document.body.contains(a.current))return}catch{return}try{const S={value:e,language:t,automaticLayout:!0,minimap:{enabled:!1},theme:i,scrollBeyondLastLine:!1,foldingHighlight:!0,foldingImportsByDefault:!1,unfoldOnClickAfterEndOfLine:!0,accessibilitySupport:"on",...d,folding:d.folding!==!1,foldingStrategy:d.foldingStrategy||"indentation",showFoldingControls:d.showFoldingControls||"always"};u=y.editor.create(a.current,S),u&&setTimeout(()=>{try{u?.layout()}catch{}},100);const o=()=>{const s=a.current?.querySelector(".editor-widget.find-widget");s&&s.querySelector(":focus")&&s.getAttribute("aria-hidden")==="true"&&s.removeAttribute("aria-hidden")},n=new MutationObserver(()=>{o()});a.current&&(n.observe(a.current,{attributes:!0,attributeFilter:["aria-hidden"],subtree:!0}),a.current.addEventListener("focusin",o,!0),a.current.addEventListener("focus",o,!0)),u._ariaObserver=n,u._ariaCleanup=()=>{n.disconnect(),a.current&&(a.current.removeEventListener("focusin",o,!0),a.current.removeEventListener("focus",o,!0))},w.current=u,j=u.onDidChangeModelContent(()=>{u&&m&&r(u.getValue())}),g&&m&&g(y,u)}catch(S){console.error("Failed to create Monaco editor:",S)}}}).catch(y=>{console.error("Failed to load Monaco editor:",y)})};return b=setTimeout(k,0),()=>{if(m=!1,b&&(clearTimeout(b),b=null),j&&(j.dispose(),j=null),u){try{u.dispose()}catch{}u=null}if(w.current){try{const h=w.current?._ariaCleanup;h&&h(),w.current.dispose()}catch{}w.current=null}}},[t,i]),E.useEffect(()=>{const m=w.current;m&&m.getValue()!==e&&m.setValue(e)},[e]),E.useEffect(()=>{const m=p.current,u=w.current;!m||!u||m.editor.setTheme(i)},[i]),B.jsx("div",{ref:a,className:_,style:{height:c}})}function ae({value:e,onChange:r,theme:t="vs",height:i="100%",options:c={},className:d,enableLsp:_=!0,onReady:g}){return B.jsx(q,{value:e,onChange:r,language:"sruja",theme:t,height:i,options:c,className:d,onReady:async(a,w)=>{if(_&&typeof window<"u")try{const{createWasmLspApi:p,initializeMonacoWasmLsp:m}=await P(async()=>{const{createWasmLspApi:j,initializeMonacoWasmLsp:b}=await import("./index.CvcSuA6H.js");return{createWasmLspApi:j,initializeMonacoWasmLsp:b}},[]),u=p();m(a,w,u)}catch(p){console.warn("Failed to initialize WASM LSP (editor will work without LSP features):",p)}g&&g(a,w)}})}class O extends Error{constructor(r,t){super(r),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cause",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="SrujaError",this.code=t?.code??"UNKNOWN_ERROR",this.context=t?.context,this.cause=t?.cause,Error.captureStackTrace&&Error.captureStackTrace(this,O)}toJSON(){const r={name:this.name,message:this.message,code:this.code,context:this.context,stack:this.stack};return this.cause&&(r.cause={name:this.cause.name,message:this.cause.message,stack:this.cause.stack}),r}}class A extends O{constructor(r,t){super(r,{code:"CONFIGURATION_ERROR",context:{...t?.context,configKey:t?.configKey}}),this.name="ConfigurationError"}}class L extends O{constructor(r,t){super(r,{code:"NETWORK_ERROR",context:{...t?.context,url:t?.url,status:t?.status},cause:t?.cause}),this.name="NetworkError"}}var V={};let R=!1,U;const C=typeof J<"u"&&V!==void 0&&!0;function H(){if(R)return!0;if(typeof window<"u"){const e=window.__SRUJA_DEBUG__;if(typeof e=="boolean")return e;try{if(window.localStorage?.getItem("sruja:debug")==="true")return!0}catch{}}return!C}function N(e){return[e.timestamp,`[${e.level.toUpperCase()}]`,e.service?`[${e.service}]`:"",e.message].filter(Boolean).join(" ")}function $(e){const r={timestamp:e.timestamp,level:e.level,message:e.message};return e.service&&(r.service=e.service),e.context&&Object.keys(e.context).length>0&&(r.context=e.context),JSON.stringify(r)}function T(e,r,t){const i=new Date().toISOString(),c={level:e,message:r,context:t,timestamp:i,service:U};if(e==="error"||e==="warn"){const _=C?$(c):N(c);if(e==="error"){console.error(_,t?JSON.stringify(t,null,2):"");try{const g=(typeof t?.component=="string"?t.component:void 0)||"unknown",a=(typeof t?.action=="string"?t.action:void 0)||"error",w=`error.${g}.${a}`,p={error_message:r,error_type:(typeof t?.errorType=="string"?t.errorType:void 0)||"unknown",...t};typeof window<"u"&&(p.user_agent=navigator.userAgent,p.screen_size=`${window.screen.width}x${window.screen.height}`,p.viewport_size=`${window.innerWidth}x${window.innerHeight}`,p.url=window.location.href.substring(0,200)),z(w,p)}catch{}}else console.warn(_,t?JSON.stringify(t,null,2):"");return}if(!H())return;const d=C?$(c):N(c);e==="info"?console.info(d,t?JSON.stringify(t,null,2):""):console.debug(d,t?JSON.stringify(t,null,2):"")}const l={setService(e){U=e},enableDebug(){R=!0},disableDebug(){R=!1},debug(e,r){T("debug",e,r)},info(e,r){T("info",e,r)},warn(e,r){T("warn",e,r)},error(e,r){T("error",e,r)}};function G(){return typeof window<"u"}function Z(e){if(!G())return e?.trailingSlash?"/":"";const r=import.meta;if(r.env?.BASE_URL){const d=r.env.BASE_URL;return e?.trailingSlash?d.endsWith("/")?d:d+"/":d.endsWith("/")?d.slice(0,-1):d}const t=window.location.pathname;if(e?.studioPath!==!1&&t.startsWith("/studio"))return e?.trailingSlash?"/":"";const i=t.match(/^(\/.+?)\//),c=i?i[1]:"";return e?.trailingSlash?c?c+"/":"/":c}function I(){return typeof window>"u"?null:window}async function Q(e){await new Promise((r,t)=>{const i=document.createElement("script");i.src=e,i.async=!0,i.onload=()=>r(),i.onerror=()=>{const c=new Error("Failed to load "+e);l.error("Failed to load wasm script",{component:"wasm",action:"load_script",scriptUrl:e,error:c.message}),t(c)},document.head.appendChild(i)})}async function D(e,r){const t=I();if(!t)throw new A("Window object not available",{configKey:"window"});if(t.Go)return;const i=[e,r.replace(/\/?$/,"/")+"wasm_exec.js","/wasm_exec.js","https://cdn.jsdelivr.net/gh/golang/go@go1.25.0/misc/wasm/wasm_exec.js"];let c=!1,d=null;for(const _ of i)try{if(await Q(_),t.Go){c=!0;break}}catch(g){d=g instanceof Error?g:new Error(String(g))}if(!c){const _=new L("Failed to load wasm_exec.js from all candidates",{url:e,cause:d||void 0,context:{candidates:i}});throw l.error("Failed to load Go wasm runtime",{component:"wasm",action:"load_go_runtime",candidates:i,error:_.message}),_}}async function X(e){if(!G())throw new A("WASM initialization requires browser environment");const r=I();if(!r)throw new A("Window object not available",{configKey:"window"});const t=e?.base||"/",i=t.replace(/\/?$/,"/")+"wasm/wasm_exec.js",c=t.replace(/\/?$/,"/")+"wasm/sruja.wasm",d=c+"?t="+Date.now();if(!e?.skipGoLoad)await D(i,t);else if(!r.Go)try{await D(i,t)}catch{}const _=r.Go;if(!_){const o=new A("wasm_exec.js not loaded - Go constructor not available",{configKey:"Go"});throw l.error("Go constructor missing",{component:"wasm",action:"init",errorType:"go_constructor_missing",error:o.message}),o}const g=new _,a=g.importObject||{};if(!a.gojs){const o=a.env||{};a.gojs=Object.keys(o).length?o:a.go||{}}a.gojs["runtime.scheduleTimeoutEvent"]||(a.gojs["runtime.scheduleTimeoutEvent"]=o=>{setTimeout(()=>{try{g._resume&&g._resume()}catch{}},o)});let w=null;const p=[d,c,t.replace(/\/?$/,"/")+"sruja.wasm","/sruja.wasm",t.replace(/\/?$/,"/")+"studio/wasm/sruja.wasm",t.replace(/\/?$/,"/")+"viewer/wasm/sruja.wasm","/wasm/sruja.wasm"];let m=null;for(const o of p)try{const n=await fetch(o);if(!n.ok)throw new L(`Failed to fetch ${o}`,{url:o,status:n.status});if(WebAssembly.instantiateStreaming)try{w=(await WebAssembly.instantiateStreaming(n,a)).instance,m=null,l.info("WASM loaded via streaming",{component:"wasm",action:"load_wasm",url:o});break}catch(s){l.warn("WASM streaming failed, falling back to arrayBuffer",{component:"wasm",action:"load_wasm",error:s instanceof Error?s.message:String(s)});const f=await fetch(o);if(!f.ok)throw new Error("Failed to re-fetch for fallback");const M=await f.arrayBuffer();w=(await WebAssembly.instantiate(M,a)).instance,m=null;break}else{const s=await n.arrayBuffer();w=(await WebAssembly.instantiate(s,a)).instance,m=null;break}}catch(n){m=n instanceof Error?n:new Error(String(n));continue}if(!w){const o=m||new L("Failed to load sruja.wasm from all candidates",{context:{candidates:p}});throw l.error("Failed to load sruja.wasm",{component:"wasm",action:"load_wasm",errorType:"wasm_load_failure",candidates:p,retries:p.length,error:o.message}),o}g.run(w),await new Promise(o=>setTimeout(o,100));let u=0;const j=150;for(;!r.sruja_parse_dsl&&u<j;)await new Promise(o=>setTimeout(o,50)),u++;if(u>=j){const o=Object.keys(r).filter(n=>n.startsWith("sruja_"));l.error("Required WASM functions not found after waiting",{component:"wasm",action:"wait_for_required",retries:u,available:o,missing:{parse:!r.sruja_parse_dsl,mermaid:!r.sruja_dsl_to_mermaid,markdown:!r.sruja_dsl_to_markdown}})}const b=r.sruja_parse_dsl,k=r.sruja_json_to_dsl,h=r.sruja_dsl_to_mermaid,y=r.sruja_dsl_to_markdown,v=r.sruja_dsl_to_likec4,S=Object.keys(r).filter(o=>o.startsWith("sruja_"));if(l.info("WASM functions loaded",{component:"wasm",action:"init_complete",available:S}),!b||!k||!h||!y){const o=[];b||o.push("sruja_parse_dsl"),k||o.push("sruja_json_to_dsl"),h||o.push("sruja_dsl_to_mermaid"),y||o.push("sruja_dsl_to_markdown");const n=Object.keys(r).filter(f=>f.startsWith("sruja_")),s=new A(`WASM functions not found. Missing: ${o.join(", ")}. Available: ${n.join(", ")||"none"}`,{configKey:"wasm_functions",context:{missing:o,available:n,retries:u}});throw l.error("WASM functions missing",{component:"wasm",action:"init",errorType:"wasm_functions_missing",missing:o,available:n,retries:u,windowKeys:Object.keys(r).filter(f=>f.includes("sruja")||f.includes("wasm")),error:s.message}),s}return{parseDslToJson:async(o,n)=>{try{const s=n||typeof location<"u"&&location.pathname||"input.sruja",f=b(o,s);if(!f||!f.ok){const M=new Error(f?.error||"parse failed");throw l.error("WASM parse failed",{component:"wasm",action:"parse_dsl",errorType:"parse_failure",errorCode:f?.error,dslLength:o.length,error:M.message}),M}return f.json||""}catch(s){throw l.error("WASM parse exception",{component:"wasm",action:"parse_dsl",errorType:"parse_exception",error:s instanceof Error?s.message:String(s)}),s}},printJsonToDsl:async o=>{try{const n=k(o);if(!n||!n.ok){const s=new Error(n?.error||"print failed");throw l.error("WASM print failed",{component:"wasm",action:"print_json",errorType:"print_failure",errorCode:n?.error,jsonLength:o.length,error:s.message}),s}return n.dsl||""}catch(n){throw l.error("WASM print exception",{component:"wasm",action:"print_json",errorType:"print_exception",error:n instanceof Error?n.message:String(n)}),n}},dslToMermaid:async o=>{try{const n=h(o);if(!n||!n.ok)throw new Error(n?.error||"mermaid export failed");return n.data||""}catch(n){throw l.error("WASM mermaid export exception",{component:"wasm",action:"export_mermaid",error:n instanceof Error?n.message:String(n)}),n}},dslToMarkdown:async o=>{try{const n=y(o);if(!n||!n.ok)throw new Error(n?.error||"markdown export failed");return n.data||""}catch(n){throw l.error("WASM markdown export exception",{component:"wasm",action:"export_markdown",error:n instanceof Error?n.message:String(n)}),n}},dslToLikeC4:async(o,n)=>{try{const s=n||typeof location<"u"&&location.pathname||"input.sruja";if(!v)throw new Error("sruja_dsl_to_likec4 function not registered");const f=v(o,s);if(!f||!f.ok)throw new Error(f?.error||"likec4 export failed");return f.data||""}catch(s){throw l.error("WASM likec4 export exception",{component:"wasm",action:"export_likec4",error:s instanceof Error?s.message:String(s)}),s}}}}let W=null,x=null;function Y(){return Z({trailingSlash:!0,studioPath:!0})}async function ee(e){return W||x||(x=(async()=>{const r=Y();return W=await X({...e,base:r}),W})(),x)}async function F(){if(W)return W;try{return await ee()}catch(e){return l.error("Failed to initialize WASM",{component:"wasm",action:"get_api",error:e instanceof Error?e.message:String(e)}),null}}async function ie(e,r){const t=await F();if(!t)return l.error("WASM not available",{component:"wasm",action:"convert_dsl_to_json"}),null;try{const i=await t.parseDslToJson(e,r);return JSON.parse(i)}catch(i){const c=i instanceof Error?i.message:String(i);throw l.error("DSL parse error",{component:"wasm",action:"convert_dsl_to_json",error:c,filename:"unknown"}),new Error(`Failed to parse DSL: ${c}`)}}async function ce(e){const r=await F();if(!r)return l.error("WASM not available",{component:"wasm",action:"convert_dsl_to_markdown"}),null;try{return await r.dslToMarkdown(e)}catch(t){return l.error("DSL to Markdown conversion error",{component:"wasm",action:"convert_dsl_to_markdown",error:t instanceof Error?t.message:String(t)}),null}}async function ue(e){const r=await F();if(!r)return l.error("WASM not available",{component:"wasm",action:"convert_dsl_to_mermaid"}),null;try{return await r.dslToMermaid(e)}catch(t){return l.error("DSL to Mermaid conversion error",{component:"wasm",action:"convert_dsl_to_mermaid",error:t instanceof Error?t.message:String(t)}),null}}export{A as C,q as M,L as N,O as S,X as a,ee as b,F as c,ie as d,ce as e,ue as f,Z as g,ae as h,G as i,l};
