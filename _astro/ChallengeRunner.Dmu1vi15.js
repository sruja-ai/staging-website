import{j as s}from"./jsx-runtime.D_zvdyIk.js";import{r as k}from"./index._4BMK3ry.js";import{B as L}from"./PosthogProvider.DHrDBjp9.js";import{M as T}from"./MantineProvider.DFlHB4BD.js";import{S as W,i as D}from"./wasmAdapter.DjwoeXOF.js";/* empty css                       */import{a as O}from"./storage.3RYs70yn.js";import{t as M}from"./analytics.C5TEplRq.js";import"./index.CO7ALg8S.js";import"./auto.qXY55obW.js";import"./modelToDsl.uflv8euP.js";function B(t,j){const i=[],m=t||"Parse error";i.push(m);const g=j.split(`
`);let r=null,f=null;const E=m.match(/line\s+(\d+)/i),y=m.match(/:(\d+):(\d+)/);if(E&&E[1]&&(r=parseInt(E[1],10)),y&&y[1]&&y[2]&&(r=parseInt(y[1],10),f=parseInt(y[2],10)),r&&r>=1&&r<=g.length){const b=Math.max(1,r-1),C=Math.min(g.length,r+1);for(let h=b;h<=C;h++){const H=h===r?">":" ",a=g[h-1];i.push(H+" Line "+h+": "+a)}if(f&&f>0&&r>=1&&r<=g.length){const h=" ".repeat(Math.max(0,("> Line "+r+": ").length+f-1))+"^";i.push(h)}}const d=m.toLowerCase();return(d.includes("unterminated string")||d.includes("missing quote")||d.includes("expected string"))&&i.push("Hint: Wrap labels and descriptions in quotes"),(d.includes("unexpected eof")||d.includes("missing closing brace")||d.includes("expected }"))&&i.push("Hint: Add a closing } for the last opened block"),(d.includes("unknown identifier")||d.includes("undefined reference"))&&i.push("Hint: Verify names are declared before use"),i.some(b=>b.startsWith("Hint:"))||g.some(C=>/->\s+[^\s]+\s+[^"\n]+$/.test(C))&&i.push('Hint: Relation labels should be quoted, e.g., Web -> API "Calls"'),i}const F={COMPLETED_CHALLENGES:"sruja:completedChallenges"},$=O(F.COMPLETED_CHALLENGES,[]);function I(){return $.get()}function q(t){const j=I(),i=new Set(j);i.add(t),$.set(Array.from(i))}function tt({challenge:t}){const[j,i]=k.useState(t.initialDsl),[m,g]=k.useState(!1),[r,f]=k.useState(null),[E,y]=k.useState(0),[d,b]=k.useState(0);k.useEffect(()=>{M("challenge.view",{slug:t.slug})},[t.slug]);const C=async()=>{g(!0),f(null);const a=[];try{y(l=>l+1);const w=await(await D()).parseDslToJson(j),v=JSON.parse(w);let N=!0;for(const l of t.checks)if(l.type==="noErrors")a.push(l.message||"No parse errors");else if(l.type==="relationExists"){const A=(e=>{const c=[],o=n=>{for(const p of n||[]){const u=p;u&&(u.from||u.source)&&(u.to||u.target)&&c.push({from:u.from??u.source??"",to:u.to??u.target??""})}};o(e?.relations||[]);for(const n of e?.systems||[]){o(n?.relations);for(const p of n?.containers||[]){o(p?.relations);for(const u of p?.components||[])o(u?.relations)}for(const p of n?.components||[])o(p?.relations)}for(const n of e?.containers||[]){o(n?.relations);for(const p of n?.components||[])o(p?.relations)}for(const n of e?.components||[])o(n?.relations);return c})(v?.architecture||v),S=(e,c)=>{if(!c)return!1;const o=String(e||"").trim(),n=String(c||"").trim();if(!o||!n)return!1;if(o===n)return!0;const p=o.split(".").pop(),u=n.split(".").pop();return!!(p&&u&&p===u||o.endsWith("."+n))};A.some(e=>S(e.from,l.source)&&S(e.to,l.target))?a.push(`Found relation ${l.source} -> ${l.target}`):(N=!1,a.push(l.message||`Add relation ${l.source} -> ${l.target}`))}else if(l.type==="elementExists"){const R=new Set,A=e=>{if(e){if(Array.isArray(e)){for(const c of e)A(c);return}if(typeof e=="object"){const c=e,o=(c.name||c.id||"").toString().trim();o&&R.add(o);for(const n of Object.keys(c))A(c[n])}}};A(v?.architecture||v);const S=(l.name||"").toString().trim();S&&Array.from(R).some(e=>{if(!e)return!1;if(e===S)return!0;const c=e.split(".").pop(),o=S.split(".").pop();return!!c&&!!o&&c===o})?a.push(`Found element ${S}`):(N=!1,a.push(l.message||`Create element ${S}`))}if(f({passed:N,details:a}),N)try{q(t.slug)}catch{}M("challenge.run",{slug:t.slug,passed:N})}catch(x){const w=x instanceof Error?x.message:String(x),v=B(w,j);f({passed:!1,details:v})}finally{g(!1)}},h=()=>{if(!t.hints||t.hints.length===0)return;const a=Math.min(t.hints.length,d+1);b(a);const x=t.hints.slice(0,a);f(w=>({passed:!1,details:[...w?.details||[],...x]}))},H=()=>{t.solution&&i(t.solution)};return s.jsx(T,{children:s.jsxs("div",{className:"challenge",children:[s.jsxs("div",{className:"header",children:[s.jsx("h2",{children:t.title}),t.summary&&s.jsx("p",{className:"summary",children:t.summary})]}),s.jsx("div",{className:"editor",children:s.jsx(W,{value:j,onChange:a=>i(a||""),theme:"vs-dark",options:{minimap:{enabled:!1},fontSize:14,wordWrap:"on"}})}),s.jsxs("div",{className:"actions",children:[s.jsx(L,{variant:"primary",onClick:C,disabled:m,isLoading:m,children:m?"Running...":"Run Tests"}),E>=1&&!r?.passed&&s.jsxs(s.Fragment,{children:[s.jsx(L,{variant:"outline",onClick:h,disabled:m||(t.hints?.length||0)===d,children:"Show Hint"}),s.jsx(L,{variant:"outline",onClick:H,disabled:m||!t.solution,children:"Reveal Solution"})]})]}),r&&s.jsxs("div",{className:`result ${r.passed?"ok":"err"}`,children:[s.jsx("strong",{children:r.passed?"Challenge passed":"Needs fixes"}),s.jsx("ul",{children:r.details.map((a,x)=>s.jsx("li",{children:a},x))})]}),s.jsx("div",{className:"hint",children:s.jsx("small",{children:"Progress is saved locally in your browser."})}),s.jsx("style",{children:`
        .challenge { border: 1px solid var(--color-border); border-radius: 8px; padding: 16px; background: var(--color-background); }
        .summary { color: var(--color-text-tertiary); }
        .editor { height: 360px; margin-top: 12px; }
        .actions { margin-top: 12px; display: flex; gap: 8px; }
        .result { margin-top: 12px; padding: 12px; border-radius: 6px; }
        .result.ok { background: var(--success-dim); border: 1px solid var(--color-success-500); }
        .result.err { background: var(--error-dim); border: 1px solid var(--color-error-500); }
        .hint { margin-top: 8px; color: var(--color-text-tertiary); }
      `})]})})}export{tt as default};
